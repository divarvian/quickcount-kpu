<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Charts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <canvas id="pieChart" width="400" height="400"></canvas>
    <canvas id="barChart" width="400" height="400"></canvas>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked>
      <label class="form-check-label" for="flexSwitchCheckChecked">Show data as Percentage?</label>
    </div>
    <script>
      async function fetchDataAndDrawChart() {
        try {
          const pilpresValue = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/hhcw/ppwp.json');
          const pilpresCandidate = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/ppwp.json');
          const dataPilpres = await pilpresValue.json();
          const dataCandidate = await pilpresCandidate.json();
          const pilegValue = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/hhcw/pdpr.json');
          const pilegPartyCandidate = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/partai.json');
          const dataPileg = await pilegValue.json();
          const dataPartyCandidate = await pilegPartyCandidate.json();
          drawChart(dataPilpres, dataCandidate, 'pieChart');
          drawChart(dataPileg, dataPartyCandidate, 'barChart');
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }

      function calculateDataValuesPercent(dataValues) {
        const totalValue = Object.values(dataValues).reduce((acc, cur) => acc + cur, 0);
        const dataValuesPercent = {};
        for (const [key, value] of Object.entries(dataValues)) {
          const percent = (value / totalValue) * 100;
          dataValuesPercent[key] = percent.toFixed(2);
        }
        return dataValuesPercent;
      }

      function drawChart(data, dataCandidate, chartId) {
        const candidateName = Object.values(dataCandidate).map(item => item.nama.split("-").join("\n"));
        const chartData = Object.values(data.chart);
        const dataVote = Object.entries(chartData).filter(([key, _]) => key !== 'persen').reduce((obj, [key, val]) => ({
          ...obj,
          [key]: val
        }), {});
        const dataPercentage = calculateDataValuesPercent(dataVote);
        const colors = Object.values(dataCandidate).map(item => item.warna);

        const chartDataConfig = {
          labels: candidateName,
          datasets: [{
            data: Object.values(dataPercentage),
            backgroundColor: colors
          }]
        };

        const chartOptions = {
          plugins: {
            legend: { display: false },
            title: { display: true, text: 'QUICK COUNT' }
          }
        };

        new Chart(document.getElementById(chartId), {
          type: chartId.startsWith('pie') ? 'pie' : 'bar',
          data: chartDataConfig,
          options: chartOptions
        });
      }

      // Toggle chart visibility based on checkbox state
      const checkbox = document.getElementById("flexSwitchCheckChecked");
      const pieChart = document.getElementById("pieChart");
      const barChart = document.getElementById("barChart");

      checkbox.addEventListener("change", function() {
        const displayPieChart = pieChart.style.display === "block";
        pieChart.style.display = displayPieChart ? "none" : "block";
        barChart.style.display = displayPieChart ? "block" : "none";
        console.log(displayPieChart ? "Showing bar chart" : "Showing pie chart");
      });

      fetchDataAndDrawChart();
      setInterval(fetchDataAndDrawChart, 5000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
  </body>
</html>
