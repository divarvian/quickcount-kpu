<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Charts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <canvas id="pieChartPercentage" width="400" height="400"></canvas>
  <canvas id="pieChartVote" width="400" height="400" style="display: none;"></canvas>
  <canvas id="barChartPercentage" width="400" height="400"></canvas>
  <canvas id="barChartVote" width="400" height="400" style="display: none;"></canvas>
  <div class="form-check form-switch">
    <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckChecked" checked>
    <label class="form-check-label" for="flexSwitchCheckChecked">Show data as Percentage?</label>
  </div>
  <script>
    async function fetchDataAndDrawChart() {
      try {
        const pilpresValue = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/hhcw/ppwp.json');
        const pilpresCandidate = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/ppwp.json');
        const dataPilpres = await pilpresValue.json();
        const dataCandidate = await pilpresCandidate.json();
        const pilegValue = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/hhcw/pdpr.json');
        const pilegPartyCandidate = await fetch('https://sirekap-obj-data.kpu.go.id/pemilu/partai.json');
        const dataPileg = await pilegValue.json();
        const dataPartyCandidate = await pilegPartyCandidate.json();
        drawPilpresChart(dataPilpres, dataCandidate, true);
        drawPilegChart(dataPileg, dataPartyCandidate, true);
      } catch (error) {
        console.error('Error fetching data:', error);
      }
    }

    function calculateDataValuesPercent(dataValues) {
      const totalValue = Object.values(dataValues).reduce((acc, cur) => acc + cur, 0);
      const dataValuesPercent = {};
      for (const [key, value] of Object.entries(dataValues)) {
        const percent = (value / totalValue) * 100;
        dataValuesPercent[key] = percent.toFixed(2);
      }
      return dataValuesPercent;
    }

    function drawChart(canvasId, dataLabels, dataValues, chartTitle, isPercentage) {
      const colors = Object.values(dataCandidate).map(item => item.warna);
      const chartData = {
        labels: dataLabels,
        datasets: [{
          data: Object.values(dataValues),
          backgroundColor: colors,
        }]
      };

      new Chart(document.getElementById(canvasId), {
        type: 'pie',
        data: chartData,
        options: {
          plugins: {
            legend: {
              display: false,
            },
            title: {
              display: true,
              text: chartTitle
            }
          }
        }
      });
    }

    function drawPilpresChart(dataPilpres, dataCandidate, isPercentage) {
      const candidateName = Object.values(dataCandidate).map(item => {
        const nameParts = item.nama.split("-");
        return nameParts.join("\n");
      });
      const chartPilpres = Object.values(dataPilpres.chart);
      const dataVote = Object.entries(chartPilpres).filter(([key, _]) => key !== 'persen').reduce((obj, [key, val]) => ({
        ...obj,
        [key]: val
      }), {});

      if (isPercentage) {
        const pilpresPercentage = calculateDataValuesPercent(dataVote);
        drawChart('pieChartPercentage', candidateName, pilpresPercentage, 'QUICK COUNT PILPRES RI 2024', true);
      } else {
        drawChart('pieChartVote', candidateName, dataVote, 'QUICK COUNT PILPRES RI 2024', false);
      }
    }

    function drawPilegChart(dataPileg, dataPartyCandidate, isPercentage) {
      const candidatePartyName = Object.values(dataPartyCandidate).filter(item => !item.is_aceh).map(item => item.nama);
      const chartPileg = Object.values(dataPileg.chart);
      const dataVote = Object.entries(chartPileg).filter(([key, _]) => key !== 'persen').reduce((obj, [key, val]) => ({
        ...obj,
        [key]: val
      }), {});

      if (isPercentage) {
        const pilegPercentage = calculateDataValuesPercent(dataVote);
        drawChart('barChartPercentage', candidatePartyName, pilegPercentage, 'QUICK COUNT DPR RI 2024', true);
      } else {
        drawChart('barChartVote', candidatePartyName, dataVote, 'QUICK COUNT DPR RI 2024', false);
      }
    }

    // Checkbox event listener
    var checkbox = document.getElementById("flexSwitchCheckChecked");
    var pieChartPercentage = document.getElementById("pieChartPercentage");
    var pieChartVote = document.getElementById("pieChartVote");
    var barChartPercentage = document.getElementById("barChartPercentage");
    var barChartVote = document.getElementById("barChartVote");
    checkbox.addEventListener("change", function() {
      if (checkbox.checked) {
        pieChartPercentage.style.display = "block";
        pieChartVote.style.display = "none";
        barChartPercentage.style.display = "block";
        barChartVote.style.display = "none";
        console.log("Checkbox is checked");
      } else {
        pieChartPercentage.style.display = "none";
        pieChartVote.style.display = "block";
        barChartPercentage.style.display = "none";
        barChartVote.style.display = "block";
        console.log("Checkbox is not checked");
      }
    });

    fetchDataAndDrawChart();
    setInterval(fetchDataAndDrawChart, 5000);
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>
